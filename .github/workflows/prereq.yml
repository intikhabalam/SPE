name: Deploy SharePoint Container

on:
  workflow_dispatch:
  push:
    branches:
      - main    
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy_sharepoint_container:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Login to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_SERVICEPRINCIPAL_CLIENT_ID }}
        client-secret: ${{ secrets.AZURE_SERVICEPRINCIPAL_CLIENT_SECRET }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}


    - name: Create Service Principal
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"

        $subscriptionId = "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
        $tenantId = "${{ secrets.AZURE_TENANT_ID }}"
        $clientId = "${{ secrets.AZURE_SERVICEPRINCIPAL_CLIENT_ID }}"
        $clientSecret = "${{ secrets.AZURE_SERVICEPRINCIPAL_CLIENT_SECRET }}"

        Write-Output "Logging into Azure..."
        az login --service-principal -u $clientId -p $clientSecret --tenant $tenantId

        Write-Output "Setting the subscription..."
        az account set --subscription $subscriptionId

        # Create a service principal
        $spName = "http://myServicePrincipal"
        $spPassword = az ad sp create-for-rbac --name $spName --query password -o tsv
        $spAppId = az ad sp show --id $spName --query appId -o tsv

        Write-Output "Service Principal AppId: $spAppId"
        Write-Output "Service Principal Password: $spPassword"