name: Deploy SharePoint Container

on:
  workflow_dispatch:
  push:
    branches:
      - main    
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy_sharepoint_container:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Login to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_SERVICEPRINCIPAL_CLIENT_ID }}
        client-secret: ${{ secrets.AZURE_SERVICEPRINCIPAL_CLIENT_SECRET }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}


    - name: Create Service Principal
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"

        $subscriptionId = "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
        $tenantId = "${{ secrets.AZURE_TENANT_ID }}"
        $clientId = "${{ secrets.AZURE_SERVICEPRINCIPAL_CLIENT_ID }}"
        $cS = "6dF8Q~1uHCLvJwPzS.LwhslkXvlb_KaMpaLyvbfm"

        Write-Output "Logging into Azure..."
        az login --service-principal -u "a07be3cc-91fb-45d1-9564-77d2a9ac7be3" -p "6dF8Q~1uHCLvJwPzS.LwhslkXvlb_KaMpaLyvbfm" --tenant "914f7cf7-562f-4c60-8f7c-3dc6ae04ad50"

        Write-Output "Setting the subscription..."
        az account set --subscription $subscriptionId

        # Create a service principal
        $spName = "http://myServicePrincipal"
        $spPassword = az ad sp create-for-rbac --name $spName --query password -o tsv
        $spAppId = az ad sp show --id $spName --query appId -o tsv

        Write-Output "Service Principal AppId: $spAppId"
        Write-Output "Service Principal Password: $spPassword"